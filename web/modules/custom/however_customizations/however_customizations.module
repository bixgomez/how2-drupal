<?php

/**
 * @file
 * Contains however_customizations.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_help().
 */
function however_customizations_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.however_customizations':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Custom functionality for the However project.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_form_alter().
 */
function however_customizations_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // Target the node edit forms for our volume content types
  if (in_array($form_id, ['node_however_volume_edit_form', 'node_however_volume_form', 
                           'node_how2_volume_edit_form', 'node_how2_volume_form'])) {
    
    // Get content type name for the message
    $example = '';
    if (strpos($form_id, 'however_volume') !== FALSE) {
      $example = 'How(ever) Volume 1';
    }
    else if (strpos($form_id, 'how2_volume') !== FALSE) {
      $example = 'How2 Volume 1';
    }
    
    // Make the title field disabled (not just readonly)
    $form['title']['widget'][0]['value']['#disabled'] = TRUE;
    
    // Add description to explain the auto-generation
    $form['title']['widget'][0]['value']['#description'] = t('This title is automatically generated based on the Volume Number. Example: @example', 
      ['@example' => $example]);
  }
  
  // Target the node edit forms for our issue content types
  if (in_array($form_id, ['node_journal_issue_edit_form', 'node_journal_issue_form', 
                          'node_how2_issue_edit_form', 'node_how2_issue_form'])) {
    
    // Get content type name for the message
    $example = '';
    if (strpos($form_id, 'journal_issue') !== FALSE) {
      $example = 'How(ever) Volume 1 Issue 1';
    }
    else if (strpos($form_id, 'how2_issue') !== FALSE) {
      $example = 'How2 Volume 1 Issue 1';
    }
    
    // Make the title field disabled (not just readonly)
    $form['title']['widget'][0]['value']['#disabled'] = TRUE;
    
    // Add description to explain the auto-generation
    $form['title']['widget'][0]['value']['#description'] = t('This title is automatically generated based on the Volume and Issue Numbers. Example: @example', 
      ['@example' => $example]);
  }
}

/**
 * Validates volume node forms.
 */
function however_customizations_volume_form_validate($form, FormStateInterface $form_state) {
  // We don't need to validate anything here since we're making the field readonly
  // But this function is kept as a placeholder in case we need to add validation later
}

/**
 * Implements hook_entity_presave().
 * To update all nodes, run drush however:update-volume-numbers
 */
function however_customizations_entity_presave(Drupal\Core\Entity\EntityInterface $entity) {
  // Skip if this is being processed by our batch update
  if ($entity->getEntityTypeId() === 'node' && isset($entity->however_skip_presave)) {
    return;
  }
  
  // Auto-generate titles for volume content types
  if ($entity->getEntityTypeId() === 'node') {
    // Check if this is one of our volume content types
    if ($entity->bundle() === 'however_volume' || $entity->bundle() === 'how2_volume') {
      // Make sure volume number field exists and has a value
      if ($entity->hasField('field_volume_number') && !$entity->field_volume_number->isEmpty()) {
        // Get volume number
        $volume_number = $entity->field_volume_number->value;
        
        // Generate title based on content type
        if ($entity->bundle() === 'however_volume') {
          $entity->setTitle("How(ever) Volume {$volume_number}");
        }
        else if ($entity->bundle() === 'how2_volume') {
          $entity->setTitle("How2 Volume {$volume_number}");
        }
      }
    }
    
    // Check if this is one of our issue content types
    if ($entity->bundle() === 'journal_issue' || $entity->bundle() === 'how2_issue') {
      // Make sure volume number and issue number fields exist and have values
      if ($entity->hasField('field_volume_number') && !$entity->field_volume_number->isEmpty() && 
          $entity->hasField('field_issue_number') && !$entity->field_issue_number->isEmpty()) {
        
        // Get volume number and issue number
        $volume_number = $entity->field_volume_number->value;
        $issue_number = $entity->field_issue_number->value;
        
        // Generate title based on content type
        if ($entity->bundle() === 'journal_issue') {
          $entity->setTitle("How(ever) Volume {$volume_number} Issue {$issue_number}");
        }
        else if ($entity->bundle() === 'how2_issue') {
          $entity->setTitle("How2 Volume {$volume_number} Issue {$issue_number}");
        }
      }
    }
  }
  
  // Define content types and their field mappings
  $content_mappings = [
    'how2_issue' => [
      'reference_field' => 'field_volume_reference',
      'number_field' => 'field_volume_number',
    ],
    'journal_issue' => [
      'reference_field' => 'field_volume_reference',
      'number_field' => 'field_volume_number',
    ],
  ];
    
  // Check if this is one of our target content types
  if ($entity->getEntityTypeId() === 'node' && isset($content_mappings[$entity->bundle()])) {
    $mapping = $content_mappings[$entity->bundle()];
    
    // Check if reference field has a value
    if (!$entity->{$mapping['reference_field']}->isEmpty()) {
      
      // Get the referenced volume entity
      $volume_reference = $entity->{$mapping['reference_field']}->entity;
      
      if ($volume_reference) {
        // Assuming the volume entity has a field called 'field_volume_number'
        if ($volume_reference->hasField('field_volume_number') && 
            !$volume_reference->field_volume_number->isEmpty()) {
          
          // Get the volume number from the referenced entity
          $volume_number = $volume_reference->field_volume_number->value;
          
          // Set the volume number on the current entity
          $entity->{$mapping['number_field']}->value = $volume_number;
        }
      }
    }
  }
}

/**
 * Implements hook_preprocess_node().
 */
function however_customizations_preprocess_node(&$variables) {
  $node = $variables['node'];
  
  // Only add navigation for volume content types
  $volume_types = ['however_volume', 'how2_volume'];
  if (in_array($node->bundle(), $volume_types)) {
    // Get navigation service
    $navigation_service = \Drupal::service('however_customizations.volume_navigation');
    
    // Get previous and next volumes
    $navigation = $navigation_service->getVolumeNavigation($node);
    
    // Add navigation to variables
    $variables['volume_navigation'] = [
      'prev' => $navigation['prev'],
      'next' => $navigation['next'],
    ];
  }
}
